@model Presentation.Models.PaymentViewModel

@{
    ViewData["Title"] = "Ödeme Sayfası";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<section class="page-title" style="background-image: url(../../images/background/page-title-bg.png);">
    <div class="auto-container">
        <div class="title-outer text-center">
            <h1 class="title">Ödeme Adımlarınız</h1>
            <ul class="page-breadcrumb">
                <li><a href="/Home">Anasayfa</a></li>
                <li><a href="/Home/Payment">Ödemeler</a></li>
                <li>Ödeme Bilgileriniz</li>
            </ul>
        </div>
    </div>
</section>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">
                        <i class="fas fa-credit-card me-2"></i>
                        Ödeme Bilgileri
                    </h3>
                </div>
                <div class="card-body">
                    @if (TempData["ErrorMessage"] != null)
                    {
                        <div class="alert alert-danger">
                            @TempData["ErrorMessage"]
                        </div>
                    }

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h5>Rezervasyon Detayları</h5>
                            <div class="border rounded p-3 bg-light">
                                <p><strong>Rezervasyon ID:</strong> @Model.ReservationId</p>
                                <p><strong>Toplam Tutar:</strong> <span class="text-primary fw-bold">@Model.TotalAmount.ToString("C")</span></p>
                                <p><strong>Ödeme Tarihi:</strong> @Model.PaymentDate.ToString("dd/MM/yyyy")</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h5>Güvenlik</h5>
                            <div class="border rounded p-3 bg-light">
                                <p class="text-muted small">
                                    <i class="fas fa-lock me-1"></i>
                                    Tüm ödeme bilgileriniz SSL ile şifrelenerek güvenli bir şekilde işlenmektedir.
                                </p>
                            </div>
                        </div>
                    </div>

                    <form asp-action="ProcessPayment" method="post" id="paymentForm">
                        <input type="hidden" asp-for="ReservationId" />
                        <input type="hidden" asp-for="TotalAmount" />
                        <input type="hidden" asp-for="PaymentDate" />

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label asp-for="PaymentMethod" class="form-label fw-bold">Ödeme Yöntemi</label>
                                    <select asp-for="PaymentMethod" class="form-select" id="paymentMethodSelect" asp-items="Html.GetEnumSelectList<Models.Enums.PaymentMethod>()">
                                        <option value="">-- Ödeme Yöntemi Seçiniz --</option>
                                    </select>
                                    <span asp-validation-for="PaymentMethod" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Kredi Kartı Bilgileri -->
                        <div id="creditCardSection" class="row" style="display: none;">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label asp-for="CardNumber" class="form-label fw-bold">Kart Numarası</label>
                                    <input asp-for="CardNumber" class="form-control" placeholder="1234 5678 9012 3456" maxlength="19" />
                                    <span asp-validation-for="CardNumber" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label asp-for="CardHolderName" class="form-label fw-bold">Kart Sahibi Adı</label>
                                    <input asp-for="CardHolderName" class="form-control" placeholder="Ad Soyad" />
                                    <span asp-validation-for="CardHolderName" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div id="creditCardDetailsSection" class="row" style="display: none;">
                            <div class="col-md-3">
                                <div class="form-group mb-3">
                                    <label asp-for="ExpiryMonth" class="form-label fw-bold">Ay</label>
                                    <select asp-for="ExpiryMonth" class="form-select">
                                        <option value="">Ay</option>
                                        @for (int i = 1; i <= 12; i++)
                                        {
                                            <option value="@i">@i.ToString("00")</option>
                                        }
                                    </select>
                                    <span asp-validation-for="ExpiryMonth" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group mb-3">
                                    <label asp-for="ExpiryYear" class="form-label fw-bold">Yıl</label>
                                    <select asp-for="ExpiryYear" class="form-select">
                                        <option value="">Yıl</option>
                                        @for (int year = DateTime.Now.Year; year <= DateTime.Now.Year + 6; year++)
                                        {
                                            <option value="@year">@year</option>
                                        }
                                    </select>
                                    <span asp-validation-for="ExpiryYear" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group mb-3">
                                    <label asp-for="CVV" class="form-label fw-bold">CVV</label>
                                    <input asp-for="CVV" class="form-control" placeholder="123" maxlength="4" />
                                    <span asp-validation-for="CVV" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <div class="form-group mb-3">
                                    <button type="submit" class="btn btn-primary btn-lg w-100">
                                        <i class="fas fa-lock me-2"></i>
                                        Ödemeyi Tamamla
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Nakit ve Banka Havalesi -->
                        <div id="otherPaymentSection" class="row" style="display: none;">
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <span id="paymentInfoText"></span>
                                </div>
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-success btn-lg">
                                        <i class="fas fa-check me-2"></i>
                                        Ödemeyi Onayla
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            function updatePaymentUI() {
                var selectedValue = parseInt($('#paymentMethodSelect').val());
                var creditCardSection = $('#creditCardSection');
                var creditCardDetailsSection = $('#creditCardDetailsSection');
                var otherPaymentSection = $('#otherPaymentSection');
                var paymentInfoText = $('#paymentInfoText');

                // Tüm bölümleri gizle
                creditCardSection.hide();
                creditCardDetailsSection.hide();
                otherPaymentSection.hide();

                if (selectedValue === 1) {
                    creditCardSection.show();
                    creditCardDetailsSection.show();
                } else if (selectedValue === 2) {
                    paymentInfoText.text('Nakit ödeme seçildi. Rezervasyon sırasında ödeme yapılacaktır.');
                    otherPaymentSection.show();
                } else if (selectedValue === 3) {
                    paymentInfoText.text('Banka havalesi seçildi. Banka bilgileri e-posta ile gönderilecektir.');
                    otherPaymentSection.show();
                }
            }

            $('#paymentMethodSelect').on('change', updatePaymentUI);
            updatePaymentUI(); // Sayfa yüklendiğinde tetiklenmeli

            // Kart numarası otomatik formatlama (4'lü gruplar)
            $('#CardNumber').on('input', function () {
                var value = $(this).val().replace(/\D/g, '').substring(0, 16);
                var formatted = value.replace(/(.{4})/g, '$1 ').trim();
                $(this).val(formatted);
            });

            // CVV yalnızca rakam
            $('#CVV').on('input', function () {
                var value = $(this).val().replace(/\D/g, '').substring(0, 4);
                $(this).val(value);
            });

            // Form submit kontrolü
            $('#paymentForm').on('submit', function (e) {
                var selectedValue = parseInt($('#paymentMethodSelect').val());
                if (selectedValue === 1) {
                    var cardNumber = $('#CardNumber').val().replace(/\s/g, '');
                    var cvv = $('#CVV').val().trim();

                    if (cardNumber.length < 16 || cvv.length < 3) {
                        alert('Lütfen geçerli kredi kartı bilgilerini girin.');
                        e.preventDefault();
                        return false;
                    }
                }

                var submitBtn = $(this).find('button[type="submit"]');
                submitBtn.prop('disabled', true);
                submitBtn.html('<i class="fas fa-spinner fa-spin me-2"></i>İşleniyor...');
            });
        });
    </script>
}
